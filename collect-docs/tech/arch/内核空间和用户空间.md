## 概述

操作系统的核心是内核，独立于普通的应用程序，可以访问**受保护的内存空间和底层硬件设备**。为了避免用户进程直接操作内核，保证内核安全，操作系统将虚拟内存划分为两部分，一部分是内核空间（Kernel-space），一部分是用户空间（User-space）。 

在 Linux 系统中，**内核模块运行在内核空间**，对应的进程处于内核态；而**用户程序运行在用户空间**，对应的进程处于用户态。内核态可以执行任意命令，调用系统的一切资源，而用户态只能执行简单的运算，不能直接调用系统资源。用户态必须通过系统接口（System Call），才能向内核发出指令。

**内核进程和用户进程所占的虚拟内存比例是 1:3**，而 Linux x86_32 系统的寻址空间（虚拟存储空间）为 4G（2 的 32 次方），将最高的 1G 的字节（从虚拟地址 0xC0000000 到 0xFFFFFFFF）供内核进程使用，称为内核空间。较低的 3G 的字节（从虚拟地址 0x00000000 到 0xBFFFFFFF），供各个用户进程使用，称为用户空间。

### 内核空间

内核空间总是驻留在内存中，它是为操作系统的内核保留的。应用程序是不允许直接在该区域进行读写或直接调用内核代码定义的函数的。

按访问权限可以分为进程私有和进程共享两块区域：

- **进程私有的虚拟内存：**每个进程都有单独的内核栈、页表、task 结构以及 mem_map 结构等。
- **进程共享的虚拟内存：**属于所有进程共享的内存区域，包括物理存储器、内核数据和内核代码区域。

### 用户空间

每个普通的用户进程都有一个单独的用户空间，处于用户态的进程不能**访问内核空间中的数据**和**不能直接调用内核函数**的 ，因此要进行系统调用的时候，就要将进程**切换到内核态**才行。

用户空间包括以下几个内存区域：

- **运行时栈：**由编译器自动释放，存放函数的参数值，局部变量和方法返回值等。每当一个函数被调用时，该函数的返回类型和一些调用的信息被存储到栈顶，调用结束后调用信息会被弹出并释放掉内存。栈区是从高地址位向低地址位增长的，是一块连续的内在区域，最大容量是由系统预先定义好的，申请的栈空间超过这个界限时会提示溢出。
- **运行时堆：**用于存放进程运行中被动态分配的内存段，位于 BSS 和栈中间的地址位。由开发人员申请分配（malloc）和释放（free）。堆是从低地址位向高地址位增长，采用链式存储结构。频繁地 malloc/free 造成内存空间的不连续，产生大量碎片。
- **代码段：**存放 CPU 可以执行的机器指令，该部分内存只能读不能写。通常代码区是共享的，即其他执行程序可调用它。假如机器中有数个进程运行相同的一个程序，那么它们就可以使用同一个代码段。
- **未初始化的数据段：**存放未初始化的全局变量，BSS 的数据在程序开始执行之前被初始化为 0 或 NULL。
- **已初始化的数据段：**存放已初始化的全局变量，包括静态全局变量、静态局部变量以及常量。
- **内存映射区域：**例如将动态库，共享内存等虚拟空间的内存映射到物理空间的内存，一般是 mmap 函数所分配的虚拟内存空间。











