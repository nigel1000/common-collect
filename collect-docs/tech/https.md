## 概述
安全的利用非对称加密算法协商出对称加密密钥并使用对称加密算法进行通信的过程。  
HTTPS=HTTP+SSL，在 HTTP 层和 TCP 之间加了一个 SSL/TLS 层。(SSL（Secure Sockets Layer）中文叫“安全套接层”，后来由于广泛应用，SSL 标准化之后就改名为 TLS（Transport Layer Security）。)  
HTTP TCP IP ---> HTTP SSL/TLS TCP IP  
Answers：  
- 为什么要用对称加密算法进行通信？非对称加密算法性能不好，不加密不安全。  
- 为什么要用非对称加密算法协商对称加密的密钥？直接传不安全，一把密钥通信双方不够用。  

## 问题场景
A 是客户端，B是服务端，C是坏人。  
### 明码传输
A 跟 B 说：明天吃饭。  
B 跟 A 说：不去。  
！！！不安全  
### 对称加密传输
A 跟 B 说：用什么对称密钥  
B 跟 A 说：用新华字典  
A 跟 B 说：明天吃饭。(用新华字典加密发送)。  
B 跟 A 说：(用新华字典解密)不去。(用新华字典加密发送)。  
！！！不安全  
当被C知道你们用新华字典解密的时候，有没有加密还重要么？  
### 非对称加密
A 跟 B 说：给我你的公钥  
B 跟 A 说：给你我的公钥  
A 跟 B 说：给你我们的通信对称密钥(使用B的公钥加密发送)  
B 跟 A 说：(使用我的私钥解密得到对称密钥)明天吃饭。(用对称密钥加密发送)。  
A 跟 B 说：(用对称密钥解密)不去。(用对称密钥加密发送)。  
！！！不安全  
假设被C劫持，C此时不篡改聊天内容，只偷窥，此时场景如下：  
A 跟 B 说：给我你的公钥 -------------- C 把消息透传到 B  
B 跟 A 说：给你我的公钥 -------------- C 返回自己的公钥给A，并保存B的公钥  
A 跟 B 说：给你我们的通信对称密钥(使用C的公钥加密发送) --------------  C 用自己的私钥解密内容得到通信对称密钥，并用B的公钥加密通信对称密钥发送给B  
B 跟 A 说：(使用我的私钥解密得到对称密钥)明天吃饭。(用对称密钥加密发送)。 --------------  C 发送内容给A并用通信对称密钥解密内容进行窥看  
A 跟 B 说：(用对称密钥解密)不去。(用对称密钥加密发送)。 --------------  C 发送内容给B并用通信对称密钥解密内容进行窥看    

A如何判断对方是B？核心在于第一次通信时出示身份证？学生证？结婚证? 由谁颁发？  

## CA 机构
B第一次与A进行通信的时候，B需要出示自己的数字证书，证明B的身份以及B的公钥，内容如下：  
- 非对称加密公钥  
- 域名 www.kaola.com  
- 证书所有人  
- 有效期  
- 发证机构  
客户端在拿到服务器的证书后，就需要验证证书编号**是否能在对应的 CA 机构查到**，并且核对证书的基本信息如**证书上的域名是否与当前访问的域名一致**等等，还可以**拿到证书中服务器的公钥信息用于协商对称密钥**！  

如何保证数字证书不被篡改？万一被C截获到数字证书，把公钥改成C的公钥，不是依然无法保证安全了么？  

CA 机构就是数字证书颁发的权威机构，负责颁发证书以及验证证书的合法性。浏览器中会存储权威的一些CA机构。(如果你觉得机构的私钥会泄露，那就无法保证通信的安全了)  
B提交信息向 CA 机构提出申请，CA 机构在给B颁发证书的时候，会连同 **数字证书*- 以及 **数字签名(根据证书进行MD5计算并用CA 机构自己的私钥进行加密后的摘要)*- 一同发送给B。  

## 最终通信方式
A 跟 B 说：给我你的数字证书和数字签名  
B 跟 A 说：给你我的数字证书和数字签名  
A 跟 B 说：(校验证书基本信息如域名所有人有效期等，根据证书的发证机构，获取浏览器内置的机构公钥，用机构公钥解密数字签名获取摘要，对数字证书进行MD5获取摘要，对比两个摘要是否相等，相等即为B)给你我们的通信对称密钥(根据证书的公钥加密发送)。  
B 跟 A 说：(使用我的私钥解密得到对称密钥)明天吃饭。(用对称密钥加密发送)。  
A 跟 B 说：(用对称密钥解密)不去。(用对称密钥加密发送)。  

第三步为什么能保证通信安全的？首先假设CA机构的私钥没泄露，内置浏览器的CA机构没被篡改，CA机构保证每个服务器的证书(即有唯一服务标识譬如域名)必须是不同的。这样数字签名只有机构公钥可以解密，MD5保证微小的差别也会导致很多的结果(即数字证书微小的篡改都会导致摘要很大的变化)。  









